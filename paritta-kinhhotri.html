<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="icon" type="image/x-icon" href="./images/favicon3.ico">
	<link rel="manifest" href="./manifest5.json">
	<meta name="theme-color" content="#8b5cf6">
	<link rel="apple-touch-icon" href="./images/icon-192-paritta.png">
	<link href="./css/css.css" rel="stylesheet">
	<link href="./css/vi.css" rel="stylesheet">
    <title>Kinh Hộ Trì</title>
 	<script src="./js/jquery-1.10.2.min.js"></script>
    <script src="./js/prdpd_i2h.js"></script>
    <script src="./js/prdpd_ebts.js"></script>
    <script src="./js/prdpd_deconstructor.js"></script>
	<script src="./js/chart.js"></script>

</head>
<body>

<div class="container" id="main-container">
<div class="top-nav">
    <button class="btn-darkmode" onclick="toggleTheme()"><i class="fas fa-moon"></i></button> 
    

        
         <div class="nav-controls">
            <button class="btn-nav" onclick="changeSection(-1)"><i class="fas fa-angle-left"></i></button>
            <select id="section-select" onchange="selectSection()"></select>
            <button class="btn-nav" onclick="changeSection(1)"><i class="fas fa-angle-right"></i></button>
	    <div id="top-right-controls" style="display: flex; gap: 3px; align-items: center;">
        
        <button class="btn-nav" onclick="openHelpModal()" title="Trợ giúp">
    <i class="fas fa-circle-info"></i>
</button>
        </div>
    </div>
</div>

<div id="section-achievement-banner">
    <h3>
        <i class="fas fa-wreath-laurel"></i> 
        Hộ Trì Pháp Bảo
        <i class="fas fa-wreath-laurel"></i>
    </h3>
    <div style="font-size:12px; margin-top:5px;">Chứng Nhận Thành Tựu Học&nbsp;Thuộc&nbsp;Lòng Kinh&nbsp;Hộ&nbsp;Trì&nbsp;Paritta</div>
</div>

	<div id="recitation-dashboard">
    <div id="dashboard-grid" class="dashboard-grid">
        </div>
    <div class="dashboard-stats">
        <div class="progress-bar-container">
            <span style="width: 120px; font-size: 12px;">Đã thuộc phần này:</span>
            <div class="progress-track"><div id="bar-session" class="progress-fill" style="background-color: #3498db;"></div></div>
            <span id="text-session" style="font-size: 12px;">0%</span>
        </div>
        <div class="progress-bar-container">
            <span style="width: 120px; font-size: 12px;">Đã thuộc tất cả:</span>
            <div class="progress-track"><div id="bar-total" class="progress-fill" style="background-color: #27ae60;"></div></div>
            <span id="text-total" style="font-size: 12px;">0%</span>
        </div>
    
	<div class="progress-bar-container" title="Nhấn vào biểu tượng bút để sửa mục tiêu">
    <span style="width: 120px; font-size: 12px;">Mục tiêu ngày: </span>
    <div class="progress-track">
        <div id="bar-daily" class="progress-fill" style="background-color: #e67e22;"></div>
    </div>
    <span id="text-daily" style="font-size: 12px; min-width: 80px; text-align: right;">
        0/100 XP 
    </span>
</div></div>
</div>
   <div class="section-header-wrapper">
        <h2 id="section-title">Đang tải...</h2>
        <i id="btn-section-info" class="fas fa-circle-info btn-info-icon" onclick="showSectionInfo()" title="Về kinh này"></i>
    </div>
    
    <h2 id="section-title-vn" style="font-weight: normal; font-size: 18px; margin-top: 0; opacity: 0.9;"></h2>
    <div id="display-area" class="text-content"></div>
</div>


<div class="bottom-bar">
    <div class="bar-main-row">
        <audio id="audioPlayer" controls>Trình duyệt không hỗ trợ audio.</audio>

    <div class="controls-cluster">         
	        <button id="btn-dictionary" class="icon-btn" onclick="togglePaliLookup()" title="Từ điển Pali"><i class="fas fa-book-open"></i></button>
			<button id="btn-stats" class="icon-btn" onclick="openStatsModal()" title="Thống kê tu tập" style="background-color: #4834d4;">
    <i class="fas fa-chart-pie"></i>
</button>
            <button id="settings-btn" class="icon-btn btn-settings" onclick="toggleSettings()" title="Cài đặt"><i class="fas fa-gear"></i></button>
		    <button id="btn-exit-recitation" class="icon-btn" onclick="exitRecitation()" title="Thoát Tụng Đọc"><i class="fas fa-xmark"></i></button>
			<button id="btn-loop" class="icon-btn" onclick="toggleLoopSentence()" title="Lặp câu hiện tại">
   <i class="fas fa-arrows-repeat"></i>
</button>
            <button id="recitation-toggle-btn" class="icon-btn btn-recitation" onclick="toggleRecitationAction()" title="Tụng Đọc"><i class="fas fa-microphone"></i></button>
			<button id="btn-random" class="icon-btn" onclick="randomSection()" title="Học giới ngẫu nhiên">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
            <circle cx="12" cy="12" r="9"></circle>
            <circle cx="12" cy="12" r="2.5"></circle>
            <line x1="12" y1="3" x2="12" y2="9.5"></line>   <line x1="12" y1="14.5" x2="12" y2="21"></line> <line x1="3" y1="12" x2="9.5" y2="12"></line>   <line x1="14.5" y1="12" x2="21" y2="12"></line> <line x1="5.64" y1="5.64" x2="10.23" y2="10.23"></line> <line x1="13.77" y1="13.77" x2="18.36" y2="18.36"></line>
            <line x1="18.36" y1="5.64" x2="13.77" y2="10.23"></line>
            <line x1="10.23" y1="13.77" x2="5.64" y2="18.36"></line>
        </svg>
    </button>
	        <button id="btn-viet-toggle" class="icon-btn" onclick="toggleVietnamese()" title="Hiển thị bản dịch">VI</button>
			<button class="icon-btn btn-nav-recitation" onclick="navigateRecitation(-1)" title="Lùi"><i class="fas fa-angles-left"></i></button>
            <button class="icon-btn btn-nav-recitation" onclick="navigateRecitation(1)" title="Tiến"><i class="fas fa-angles-right"></i></button>
        </div>
    </div>

    <div id="settings-panel" class="settings-panel">
        <div class="settings-content">
            <div class="setting-group">
                <span style="font-size:13px; font-weight:600">Ẩn chữ:</span>
                <input type="range" id="difficulty" min="10" max="90" value="40" oninput="updateLabel(this.value)" style="width:80px">
                <span id="difficulty-label" style="font-size:12px">40%</span>
                <button class="btn-sm" onclick="hideRandomWords()" style="background:#d35400; color:white;">Ẩn</button>
                <button class="btn-sm" onclick="resetText(true)" style="background:#7f8c8d; color:white;">Hiện</button>
            </div>

            <div class="setting-group">
                <span style="font-size:13px; font-weight:600">Tốc độ:</span>
                
                <button id="btn-show-speed" class="btn-sm" onclick="toggleSpeedControl()" style="background:#2980b9; color:white;"><i class="far fa-clock"></i></button><span id="btn-show-speed2" style="font-size:13px; font-weight:600"> (Đồng bộ)</span>

                <div id="speed-control-area" style="display:none; align-items:center; gap:5px;">
                    <input type="range" id="recitation-interval" min="1" max="10" step="0.5" value="3" oninput="updateRecitationInterval(this.value)" style="width:80px">
                    <span id="recitation-interval-label" style="font-size:12px">3.0s</span>
                    <button class="btn-sm" onclick="resetSpeedDefault()" style="background:#6a4c93; color:white;" title="Huỷ tuỳ chỉnh, dùng thời gian gốc">Về mặc định</button>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="help-modal" class="help-modal-overlay" onclick="closeHelpModal(event)">
    <div class="help-modal-content">
        <div class="help-modal-header">
            <h3>Kinh Hộ Trì Paritta</h3>
            <button class="btn-close-help" onclick="closeHelpModal(event)"><i class="fas fa-xmark"></i></button>
        </div>
		<div class="help-modal-body">
    <p>Đây là ứng dụng & công cụ được thiết kế để hỗ trợ các hành giả trong việc nghe, học, và tụng trì hàng ngày <b>Kinh Hộ Trì Paritta.</b> Ứng dụng có tính năng đồng bộ văn bản với âm thanh cho phép thực hành tụng đọc theo chính xác, đồng thời bao gồm các bài tập ghi nhớ bằng cách ẩn ngẫu nhiên các từ, và một bảng điều khiển tương tác để theo dõi tiến độ học thuộc.</p>

    <h4><i class="fas fa-book-open-reader"></i> Hướng Dẫn</h4>
    
    <h4>1. Điều Hướng & Cơ Bản</h4>
    <ul>
        <li><b>Giao Diện (<i class="fas fa-moon"></i>/<i class="fas fa-sun-bright"></i>):</b> Chuyển đổi giữa Chế độ Sáng và Tối.</li>
        <li><b>Chọn Mục:</b> Sử dụng menu thả xuống để chuyển đến một bài kinh cụ thể (ví dụ: Maṅgalasutta, Mettasutta)</li>
        <li><b>Ngẫu Nhiên (<i class="far fa-dharmachakra"></i>):</b> Chuyển đến một bài kinh bất kỳ.</li>
        <li><b>Từ điển (<i class="fas fa-book-open"></i>):</b> Bật để tra cứu từ Pāli bằng cách di chuột qua từ. Trong <i>Chế độ Tụng đọc</i>, tính năng này sẽ hiển thị nhịp vận âm tụng (<i class="fas fa-dash"></i> cho âm dài, <i class="fas fa-dot"></i> cho âm ngắn) theo quy tắc <b>Vuttodaya</b> cổ điển.</li>
		<li><b>Thống Kê (<i class="fas fa-chart-pie"></i>):</b> Nhấn nút để xem biểu đồ XP, đặt <b>Mục tiêu hằng ngày</b> (<i class="fas fa-pen"></i>) và theo dõi lịch sử tu tập theo Tuần/Tháng.</li>
    </ul>

    <h4>2. Chế Độ Tụng Đọc (<i class="fas fa-microphone"></i>)</h4>
    <p>Nhấn nút Micro để vào Chế độ Tụng Đọc. Chữ sẽ phóng to và chạy theo âm thanh.</p>
    <ul>
        <li><b>Trạng thái:</b> Xanh Lá = Tự động chạy; Xanh Dương = Tạm dừng/Thủ công.</li>
        <li><b>Điều hướng:</b> Dùng <b>«</b> và <b>»</b> để nhảy dòng.</li>
    </ul>

    <h4>3. Chế Độ Lặp (Ôn Luyện)</h4>
    <ul>
        <li><b>Lặp Một Câu:</b> Nhấn nút Lặp (<i class="fas fa-arrows-repeat"></i>) trên thanh điều khiển để lặp lại câu hiện tại liên tục.</li>
        <li><b>Lặp Nhiều Câu (Tùy Chọn):</b> 
            <ul>
                <li>Trên <b>Lưới Tiến Độ</b> (các ô số màu), <b>Nhấn Giữ</b> vào một ô để chọn. Ô sẽ chuyển sang viền Đỏ.</li>
                <li>Chọn nhiều ô để tạo vòng lặp tùy chỉnh (ví dụ: ôn một đoạn khó). Trình phát sẽ chỉ lặp qua các câu đã chọn.</li>
                <li>Nhấn giữ lần nữa để bỏ chọn.</li>
            </ul>
        </li>
		<li><b>Lặp Mặc Định:</b> Khi không ấn vào, nút Lặp sẽ phát lại toàn bộ mục hiện tại.</li>
    </ul>

    <h4>4. Bảng Tiến Độ & Ghi Nhớ</h4>
    <p>Nằm phía trên văn bản khi ở Chế độ Tụng Đọc, bảng này giúp trực quan hóa mức độ thông thuộc của bạn.</p>
    <ul>
        <li><b>Lưới Màu:</b> Mỗi ô vuông đại diện cho một dòng.
            <ul>
                <li><b>Xám:</b> Chưa thuộc.</li>
                <li><b>Xanh:</b> Đã thuộc.</li>
            </ul>
        </li>
        <li><b>Đánh Dấu:</b> Khi dòng đang chạy, ô chọn <b>"Đã thuộc"</b> sẽ hiện dưới văn bản. Đánh dấu vào đó để xác nhận đã thuộc (100%).</li>
        <li><b>Thống Kê:</b>
            <ul>
                <li><b>Đã thuộc phần này:</b> % hoàn thành của bài kinh hiện tại.</li>
                <li><b>Đã thuộc tất cả:</b> % hoàn thành của toàn bộ các Kinh Hộ Trì.</li>
            </ul>
        </li> </ul>
	<h4>5. Hệ Thống Ôn Tập & Kiểm Tra <i class="fas fa-clipboard-check"></i></h4>
    <p>Để đảm bảo bạn thực sự ghi nhớ, ứng dụng tích hợp hệ thống kiểm tra trắc nghiệm:</p>
    <ul>
        <li><b>Xác nhận "Đã thuộc":</b> Khi bạn tích vào ô chọn <i>"Đã thuộc"</i> bên cạnh một câu, một bài kiểm tra nhỏ sẽ hiện ra. Bạn phải chọn đúng từ còn thiếu để hệ thống ghi nhận câu đó là đã thuộc.</li>
		<li><b>Nút "Luyện Tập" (<i class="fas fa-bullseye-arrow"></i>):</b> Nhấn vào để làm bài tập nhanh (Điền từ & Dịch nghĩa) cho riêng câu đó nhằm củng cố trí nhớ.</li>
        <li><b>Bài Thi Tổng Hợp:</b> Khi bạn đã thuộc 100% các câu trong một bài kinh, nút <b>"Bắt đầu kiểm tra"</b> sẽ xuất hiện. Bạn cần vượt qua bài thi ngẫu nhiên (10 câu) để nhận Chứng Nhận Thành Tựu cho bài kinh đó.</li>
        <li><b>Ôn Tập Tùy Chọn:</b> Bạn có thể chọn các ô trên lưới (nhấn giữ), sau đó hệ thống sẽ tạo một bài kiểm tra riêng chỉ gồm những câu bạn đã chọn để ôn tập lại.</li>
        <li><b>Thành Tựu:</b> Bạn sẽ nhận Biểu ngữ "Hộ Trì Học Pháp" khi thuộc xong một bài kinh, và Huy chương "Bậc Hộ Trì Pháp" khi thuộc toàn bộ.</li>
    </ul>

    <h4>6. Cài Đặt (<i class="fas fa-gear"></i>)</h4>
    <ul>
        <li><b>Ẩn Chữ:</b> Kéo thanh trượt để ẩn ngẫu nhiên các từ (10%-90%) để kiểm tra trí nhớ. Nhấn vào ô trống để hiện từ.</li>
        <li><b>Tốc Độ (<i class="far fa-clock"></i>):</b> Ghi đè thời gian mặc định (ví dụ: cố định 5 giây/dòng) dùng cho việc thực hành tụng đọc ở tốc độ ổn định, chậm hơn hoặc nhanh hơn mà không cần đồng bộ âm thanh.</li>
    </ul>

    <h4><i class="fas fa-floppy-disk"></i> Sử Dụng Ngoại Tuyến</h4>
    <p>
        Tải xuống tệp Apk cho Android, tệp Zip cho PC, hoặc tệp ZIM cho Kiwix.
        (Tìm hiểu thêm về Kiwix: <a href="https://kiwix.org/en/" target="_blank">kiwix.org</a>).
    </p>
    <p>Tải xuống & Mã Nguồn: <a href="https://github.com/buddhanussati/paritta-chanting"><b>tại đây.</b></a></p>

    <h4><i class="fas fa-scale-balanced"></i>&nbsp;&nbsp;Giấy Phép</h4>
    <p>
        Cấp phép theo <a href="https://creativecommons.org/licenses/by-nc/4.0/legalcode" target="_blank">CC BY-NC 4.0</a>.
        Được phép Chia sẻ và Chuyển thể cho mục đích <b>phi thương mại</b>.
    </p>
	<button class="btn-bottom-close" onclick="closeHelpModal(event)">Đóng</button>
        </div></div>
</div>
<div id="simple-info-modal" class="simple-modal-overlay">
    <div class="simple-modal-content">
        <div class="simple-modal-header">
            <h3 id="simple-modal-title">Về Kinh này</h3>
            <button class="btn-close-simple" onclick="closeSimpleInfoModal()"><i class="fas fa-times"></i></button>
        </div>
        <div id="simple-modal-body" class="simple-modal-body">
            </div>
    </div>
</div>
<div id="grand-achievement-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="medal-icon">
            <i class="far fa-wreath-laurel"></i>
        </div>
        
        <div class="modal-title">Bậc Hộ Trì Pháp</div>
        
        <p class="modal-text">
            Chứng Nhận Thành Tựu Học&nbsp;Thuộc&nbsp;Lòng <b>Kinh&nbsp;Hộ&nbsp;Trì&nbsp;Paritta</b><br>
            
            <span style="display: block; color: #b35900; font-weight: 600; font-style: italic; margin-top: 15px;">
        "Ðệ tử Gotama<br>
        Luôn luôn tự tỉnh giác,<br>
        Vô luận ngày hay đêm,<br>
        Tưởng Chánh Pháp thường niệm."
    </span>
        </p>
        
        <button class="btn-close-modal" onclick="closeAchievementModal()">Sādhu! Lành thay!</button>
    </div>
</div>
<div id="quiz-modal" class="modal-overlay">
    <div class="modal-content quiz-content">
        <div class="quiz-header">
            <h3 id="quiz-title">Kiểm Tra Ghi Nhớ</h3>
            <div id="quiz-progress">Câu 1/2</div>
        </div>
        
        <div id="quiz-body">
            <p id="quiz-instruction-text" class="quiz-instruction">Chọn từ bên dưới để điền vào chỗ trống:</p>
            
            <div id="quiz-sentence-area" class="quiz-sentence-area">
                </div>

            <div id="quiz-options-area" class="quiz-options-area">
                </div>
        </div>

        <div id="quiz-feedback" class="quiz-feedback" style="display:none;"></div>

        <div class="quiz-footer">
            <button id="btn-quiz-cancel" class="btn-secondary" onclick="closeQuizModal()">Hủy</button>
            <button id="btn-quiz-reset" class="btn-warning" onclick="resetCurrentQuestion()" style="display:none;">Làm lại</button>
            <button id="btn-quiz-next" class="btn-primary" onclick="nextQuizQuestion()" disabled>Tiếp tục</button>
        </div>
    </div>
</div>
<div id="stats-modal" class="modal-overlay">
    <div class="modal-content stats-content" style="max-width: 900px; width: 95%; max-height: 90vh; display: flex; flex-direction: column; overflow: hidden; padding: 0;">
        
        <div class="quiz-header" style="padding: 15px 20px; margin: 0; flex-shrink: 0; border-bottom: 1px solid rgba(128,128,128, 0.3); display: flex; justify-content: space-between; align-items: center; background: inherit;">
            <h3 style="margin: 0;">Thống Kê Tu Tập</h3>
            <button class="btn-close-simple" onclick="closeStatsModal()"><i class="fas fa-times"></i></button>
        </div>
        
        <div class="stats-body" style="padding: 20px; overflow-y: auto; flex-grow: 1;">
            <div class="dashboard-grid" style="display: grid; grid-template-columns: 1fr; gap: 20px;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px;">
                    
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 id="breakdown-title" style="margin: 0; font-size: 16px;">Tổng quan</h4>
                            <select id="report-range-select" class="form-control" style="width: auto; padding: 5px; font-size: 13px; height: 32px;" onchange="renderStatsCharts(true)">
                                <option value="all">Toàn bộ</option>
                                <option value="today">Hôm nay</option>
                                <option value="yesterday">Hôm qua</option>
                                <option value="this_week" selected>Tuần này</option>
                                <option value="last_week">Tuần trước</option>
                                <option value="this_month">Tháng này</option>
                                <option value="last_month">Tháng trước</option>
                            </select>
                        </div>
                        <div style="height: 300px; display:flex; justify-content:center;">
                            <canvas id="sectionXPChart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <button class="btn btn-secondary" style="padding: 5px 10px;" onclick="changeStatsWeek(-1)"><i class="fas fa-chevron-left"></i></button>
                            <h4 id="weekly-report-title" style="margin: 0; font-size: 16px;">Tiêu điểm tuần</h4>
                            <button class="btn btn-secondary" style="padding: 5px 10px;" onclick="changeStatsWeek(1)"><i class="fas fa-chevron-right"></i></button>
                        </div>
                        <div style="height: 300px;">
                            <canvas id="weeklyXPChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <button class="btn btn-secondary" style="padding: 5px 10px;" onclick="changeStatsMonth(-1)"><i class="fas fa-chevron-left"></i></button>
                        <h4 id="monthly-report-title" style="margin: 0; font-size: 16px;">Tiêu điểm tháng</h4>
                        <button class="btn btn-secondary" style="padding: 5px 10px;" onclick="changeStatsMonth(1)"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    <div style="height: 300px;">
                        <canvas id="monthlyXPChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="./js/vi-paritta.js"></script>
</body>
</html>